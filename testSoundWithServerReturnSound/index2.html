<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Web Audio API: AudioBuffer</title>
  </head>

  <body>
    <h1>Web Audio API: AudioBuffer</h1>
    <button>Make white noise</button>
    <form>
        <input type="file" id="my-file-input" multiple="multiple" accept="audio/*">
    </form>
  </body>

  <script>
    const button = document.querySelector("button");

    let audioCtx;

    // Stereo
    let channels = 1;

    function init() {
      audioCtx = new AudioContext();
    }

    button.onclick = () => {
      if (!audioCtx) {
        init();
      }

      async function getData(file) {
        let audioData = await file.arrayBuffer();
        console.log(audioData, "*");

        let audioCtx = new AudioContext({sampleRate: 10000}); // 10000

        let decodedData = await audioCtx.decodeAudioData(audioData); // audio is resampled to the AudioContext's sampling rate
        console.log(decodedData, "***");

        console.log(decodedData.length, decodedData.duration, decodedData.sampleRate, decodedData.numberOfChannels);

        return decodedData.getChannelData(0); 
    }

    const frameCount = 10000 * 100;

    const buffer = new AudioBuffer({
      numberOfChannels: channels,
      length: frameCount,
      sampleRate: 10000,
    });

    async function addToBuf() {
        const files = document.getElementById('my-file-input').files;

        for (let kk = 0; kk < 100; kk++) {
            let res = await getData(files[kk % 8]);
            console.log(res);


            for (let channel = 0; channel < channels; channel++) {
                // This gives us the actual array that contains the data
                const nowBuffering = buffer.getChannelData(channel);
                for (let i = 0; i < 10000; i++) {
                    // Math.random() is in [0; 1.0]
                    // audio needs to be in [-1.0; 1.0]
                    nowBuffering[i + kk * 10000] = res[i];
                  }
            }
            function delay(time) {
                return new Promise(resolve => setTimeout(resolve, time));
              }
        }
        
    }

    addToBuf();

    const source = audioCtx.createBufferSource();
    source.buffer = buffer;
    source.connect(audioCtx.destination);
    source.start();
    };
  </script>

  <script> </script>
</html>